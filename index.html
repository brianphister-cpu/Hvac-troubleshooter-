
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HVAC Troubleshooter Pro</title>
<link rel="manifest" href="/Hvac-troubleshooter-/manifest.json">
<link rel="icon" href="/Hvac-troubleshooter-/icon-192.png">
<meta name="theme-color" content="#e4eef8" />
<style>
  :root{
    --bg:#eef5fb; --bg2:#f7fbff; --panel:#ffffff; --ink:#0c263b;
    --muted:#5a748a; --line:#d8e6f3; --accent:#3e8cff;
    --cool:#2c9fff; --hot:#ff6a3d; --meter:#31c48d;
  }
  html,body{margin:0;height:100%;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink)}
  .app{max-width:1160px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  .logo{width:56px;height:56px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(62,140,255,0.15)}
  .logo img{width:40px;height:40px;border-radius:10px}
  h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px}
  p.lead{margin:2px 0 0;color:var(--muted);font-size:13px}
  #installBtn{display:none;padding:10px 14px;border:0;border-radius:10px;font-weight:800;background:linear-gradient(90deg,#7eb5ff,#a8e0ff);color:#0a1c2a;cursor:pointer;box-shadow:0 6px 14px rgba(62,140,255,0.25)}
  .main{display:grid;grid-template-columns:1fr 460px;gap:16px;margin-top:18px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 8px 22px rgba(10,30,50,0.06)}
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fcfdff;color:var(--ink);font-size:15px}
  .section-title{font-size:12px;color:var(--muted);margin:6px 0 8px;font-weight:900;text-transform:uppercase;letter-spacing:.08em}
  .btn{padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(90deg,#6fabff,#8fd4ff);color:#0a1c2a;box-shadow:0 8px 16px rgba(111,171,255,0.35)}
  .btn.secondary{background:#eef5fb;color:#0a1c2a;border:1px solid var(--line)}
  .metric-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .metric{background:#f6fbff;border:1px solid var(--line);padding:10px;border-radius:10px;min-width:120px}
  .metric .k{font-size:12px;color:var(--muted)} .metric .v{font-weight:900}
  .cause{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:#f6fbff;border:1px solid var(--line);margin-top:8px}
  .bar{flex:1;height:10px;background:#e8f2fc;border-radius:6px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--cool),var(--hot))}
  .history{max-height:220px;overflow:auto}
  .hist{display:flex;justify-content:space-between;align-items:center;background:#f9fcff;border:1px solid var(--line);padding:8px;border-radius:8px;margin-top:6px}
  .legend{display:flex;gap:10px;color:var(--muted);font-size:12px;align-items:center}
  .legend i{display:inline-block;width:14px;height:10px;border-radius:3px}
  @media(max-width:980px){.main{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo"><img src="/Hvac-troubleshooter-/icon-192.png" alt="HV"></div>
    <div>
      <h1>HVAC Troubleshooter — Pro</h1>
      <p class="lead">Realistic cycle diagram • Lighter UI • Offline PWA • R410A, R32, R454B, R22</p>
    </div>
    <button id="installBtn">Install HVAC Troubleshooter Pro</button>
  </header>

  <div class="main">
    <div class="panel">
      <div class="section-title">System & Environment</div>
      <div class="form-grid">
        <div>
          <label>Refrigerant</label>
          <select id="refrig">
            <option value="R410A">R-410A</option>
            <option value="R32">R-32</option>
            <option value="R454B">R-454B</option>
            <option value="R22">R-22</option>
          </select>
        </div>
        <div>
          <label>System Type</label>
          <select id="systemType"><option value="txv">TXV (subcool)</option><option value="fixed">Fixed (superheat)</option></select>
        </div>
        <div><label>Indoor DB (°F)</label><input id="indoorDb" type="number" placeholder="75"></div>
        <div><label>Indoor WB (°F)</label><input id="indoorWb" type="number" placeholder="63"></div>
        <div><label>Outdoor DB (°F)</label><input id="outdoorDb" type="number" placeholder="95"></div>
        <div><label>Target Superheat (°F)</label><input id="targetSH" type="number" value="10"></div>
        <div><label>Target Subcool (°F)</label><input id="targetSC" type="number" value="10"></div>
      </div>

      <hr style="margin:12px 0;border:0;border-top:1px solid var(--line)">

      <div class="section-title">Refrigerant Cycle (Realistic)</div>
      <div style="display:grid;grid-template-columns:1.1fr 1fr;gap:12px;align-items:center">
        <div id="diagram" aria-label="Refrigerant cycle diagram">
          <!-- More realistic SVG with finned coils, arrows, and components -->
          <svg viewBox="0 0 880 420" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto">
            <!-- Evaporator (finned coil) -->
            <g transform="translate(30,250)">
              <rect x="0" y="0" width="300" height="110" rx="12" fill="#eaf6ff" stroke="#cfe7fb"/>
              <!-- fins -->
              <g stroke="#d8ecff">
                <line x1="10" y1="10" x2="10" y2="100"/><line x1="25" y1="10" x2="25" y2="100"/><line x1="40" y1="10" x2="40" y2="100"/>
                <line x1="55" y1="10" x2="55" y2="100"/><line x1="70" y1="10" x2="70" y2="100"/><line x1="85" y1="10" x2="85" y2="100"/>
                <line x1="100" y1="10" x2="100" y2="100"/><line x1="115" y1="10" x2="115" y2="100"/><line x1="130" y1="10" x2="130" y2="100"/>
                <line x1="145" y1="10" x2="145" y2="100"/><line x1="160" y1="10" x2="160" y2="100"/><line x1="175" y1="10" x2="175" y2="100"/>
                <line x1="190" y1="10" x2="190" y2="100"/><line x1="205" y1="10" x2="205" y2="100"/><line x1="220" y1="10" x2="220" y2="100"/>
                <line x1="235" y1="10" x2="235" y2="100"/><line x1="250" y1="10" x2="250" y2="100"/><line x1="265" y1="10" x2="265" y2="100"/>
                <line x1="280" y1="10" x2="280" y2="100"/><line x1="295" y1="10" x2="295" y2="100"/>
              </g>
              <text x="150" y="62" text-anchor="middle" fill="#2b5b7a" font-size="14" font-weight="700">Evaporator Coil</text>
            </g>

            <!-- Suction line to compressor (cool arrow) -->
            <path d="M330 305 C 380 305, 395 210, 450 210" stroke="var(--cool)" stroke-width="8" fill="none" marker-end="url(#arrowCool)"/>

            <!-- Compressor (cylinder) -->
            <g transform="translate(450,150)">
              <rect x="0" y="0" width="120" height="120" rx="20" fill="#fff" stroke="#d5e4f2"/>
              <circle cx="60" cy="60" r="20" fill="#f3f9ff" stroke="#cfe2f1"/>
              <text x="60" y="66" text-anchor="middle" fill="#2b5b7a" font-size="14" font-weight="700">Compressor</text>
            </g>

            <!-- Discharge to condenser (hot arrow) -->
            <path d="M570 210 C 620 210, 650 170, 700 170" stroke="var(--hot)" stroke-width="8" fill="none" marker-end="url(#arrowHot)"/>

            <!-- Condenser (finned coil) -->
            <g transform="translate(700,100)">
              <rect x="0" y="0" width="140" height="140" rx="12" fill="#ffeae4" stroke="#ffd4c8"/>
              <!-- fins -->
              <g stroke="#ffdcd2">
                <line x1="10" y1="10" x2="10" y2="130"/><line x1="25" y1="10" x2="25" y2="130"/><line x1="40" y1="10" x2="40" y2="130"/>
                <line x1="55" y1="10" x2="55" y2="130"/><line x1="70" y1="10" x2="70" y2="130"/><line x1="85" y1="10" x2="85" y2="130"/>
                <line x1="100" y1="10" x2="100" y2="130"/><line x1="115" y1="10" x2="115" y2="130"/><line x1="130" y1="10" x2="130" y2="130"/>
              </g>
              <text x="70" y="78" text-anchor="middle" fill="#7a3b2b" font-size="14" font-weight="700">Condenser</text>
            </g>

            <!-- Liquid line to metering device (hot to meter) -->
            <path d="M700 240 C 640 240, 580 320, 520 320" stroke="var(--hot)" stroke-width="8" fill="none"/>

            <!-- Metering device (TXV symbol-ish) -->
            <g transform="translate(500,300)">
              <rect x="0" y="0" width="100" height="50" rx="10" fill="#f2fff9" stroke="#cfeedd"/>
              <path d="M10 25 L90 25" stroke="#31c48d" stroke-width="3"/>
              <circle cx="50" cy="25" r="8" fill="none" stroke="#31c48d" stroke-width="3"/>
              <text x="50" y="42" text-anchor="middle" fill="#2b5b7a" font-size="12" font-weight="700">Meter</text>
            </g>

            <!-- Liquid to meter arrow -->
            <path d="M520 320 C 470 320, 430 305, 350 305" stroke="var(--hot)" stroke-width="8" fill="none" marker-end="url(#arrowHot)"/>

            <!-- Meter to evaporator (cool arrow) -->
            <path d="M350 305 C 330 305, 320 305, 330 305" stroke="var(--cool)" stroke-width="8" fill="none" marker-end="url(#arrowCool)"/>

            <!-- Arrow markers -->
            <defs>
              <marker id="arrowCool" markerWidth="8" markerHeight="8" refX="5" refY="3" orient="auto">
                <path d="M0,0 L0,6 L6,3 z" fill="var(--cool)"/>
              </marker>
              <marker id="arrowHot" markerWidth="8" markerHeight="8" refX="5" refY="3" orient="auto">
                <path d="M0,0 L0,6 L6,3 z" fill="var(--hot)"/>
              </marker>
            </defs>
          </svg>
          <div class="legend" style="margin-top:6px">
            <span>Low side</span><i style="background:var(--cool)"></i>
            <span>High side</span><i style="background:var(--hot)"></i>
            <span>Meter</span><i style="background:var(--meter)"></i>
          </div>
        </div>

        <div>
          <div class="section-title">Field Readings</div>
          <div class="form-grid">
            <div><label>Suction Pressure (psig)</label><input id="suctionP" type="number" placeholder="118"></div>
            <div><label>Suction Line Temp (°F)</label><input id="suctionT" type="number" placeholder="52"></div>
          </div>

          <div class="section-title">Condenser</div>
          <div class="form-grid">
            <div><label>Liquid Pressure (psig)</label><input id="liquidP" type="number" placeholder="380"></div>
            <div><label>Liquid Line Temp (°F)</label><input id="liquidT" type="number" placeholder="95"></div>
          </div>

          <div class="section-title">Optional — Air Temps</div>
          <div class="form-grid">
            <div><label>Supply Air Temp (°F) — SAT</label><input id="supplyT" type="number" placeholder="optional"></div>
            <div><label>Return Air Temp (°F) — RAT</label><input id="returnT" type="number" placeholder="optional"></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn primary" id="diagBtn" onclick="_diagClick()">Diagnose</button>
            <button class="btn secondary" id="saveBtn" onclick="_saveClick()">Save Reading</button>
          </div>
        </div>
      </div>
    </div>

    <aside class="panel">
      <div class="section-title">Diagnosis</div>
      <div class="panel" style="padding:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:800">Primary Likely Fault</div>
            <div id="primaryFault" style="font-size:20px;font-weight:900;margin-top:4px">—</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:800">Confidence</div>
            <div id="confPct" style="font-size:22px;font-weight:900;color:#3e8cff">—%</div>
          </div>
        </div>
        <div class="metric-row">
          <div class="metric"><div class="k">Evap Sat</div><div class="v" id="evapSat">— °F</div></div>
          <div class="metric"><div class="k">Cond Sat</div><div class="v" id="condSat">— °F</div></div>
          <div class="metric"><div class="k">Superheat</div><div class="v" id="superheat">— °F</div></div>
          <div class="metric"><div class="k">Subcool</div><div class="v" id="subcool">— °F</div></div>
          <div class="metric"><div class="k">ΔT (RAT−SAT)</div><div class="v" id="deltat">— °F</div></div>
        </div>
        <div style="margin-top:10px">
          <div style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:800">Possible Causes (ranked)</div>
          <div id="causesList" style="margin-top:6px"></div>
        </div>
        <div style="margin-top:10px;font-size:13px;color:var(--muted)"><strong>Recommended Next Steps</strong>
          <ul id="nextSteps" style="margin-top:6px"></ul>
        </div>
      </div>

      <div class="section-title" style="margin-top:10px">History</div>
      <div class="panel" style="padding:12px">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:6px">
          <button class="btn secondary" id="exportHist">Export History CSV</button>
          <button class="btn secondary" id="clearHist">Clear</button>
        </div>
        <div class="history" id="historyList">No saved readings.</div>
      </div>
    </aside>
  </div>

  <footer style="text-align:center;color:var(--muted);font-size:12px;margin-top:12px">On iPhone, use Safari → Share → Add to Home Screen. On Android, tap the Install button or browser menu. Works offline after first load.</footer>
</div>

<script>
(function(){
  function $(id){return document.getElementById(id);}
  function toNum(v){ const n=Number(v); return isNaN(n)?null:n; }
  function round1(n){ return n==null?null:Math.round(n*10)/10; }

  // Install button logic
  let deferredPrompt;
  const installBtn = $('installBtn');
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(installBtn) installBtn.style.display = 'inline-block'; });
  if (installBtn) installBtn.addEventListener('click', async () => { if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display = 'none'; });
  function isStandalone() { return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true; }
  if (isStandalone() && installBtn) installBtn.style.display = 'none';
  window.addEventListener('appinstalled', ()=>{ if (installBtn) installBtn.style.display='none'; });

  // Embedded PT tables (approximate; good for field interpolation)
  const DEFAULT_PT = {
    R410A:[{t:30,p:99},{t:35,p:109},{t:40,p:118},{t:45,p:130},{t:50,p:143},{t:55,p:156},{t:60,p:170},{t:65,p:185},{t:70,p:201},{t:75,p:218},{t:80,p:236},{t:85,p:277},{t:90,p:299},{t:95,p:321},{t:100,p:344},{t:105,p:368},{t:110,p:393},{t:115,p:418},{t:120,p:444},{t:125,p:471},{t:130,p:499}],
    R32:[{t:30,p:71},{t:35,p:80},{t:40,p:90},{t:45,p:101},{t:50,p:112},{t:55,p:124},{t:60,p:137},{t:65,p:150},{t:70,p:164},{t:75,p:179},{t:80,p:195},{t:85,p:211},{t:90,p:228}],
    R454B:[{t:30,p:82},{t:35,p:91},{t:40,p:100},{t:45,p:110},{t:50,p:121},{t:55,p:132},{t:60,p:144},{t:65,p:156},{t:70,p:169},{t:75,p:182},{t:80,p:196},{t:85,p:210},{t:90,p:225}],
    R22:[{t:30,p:78},{t:35,p:89},{t:40,p:102},{t:45,p:115},{t:50,p:129},{t:55,p:145},{t:60,p:161},{t:65,p:179},{t:70,p:198},{t:75,p:219},{t:80,p:242}]
  };

  function pressureToSatTemp(refrig, psig){
    const table = DEFAULT_PT[refrig]; if(!table || psig==null) return null;
    if(psig <= table[0].p) return table[0].t; if(psig >= table[table.length-1].p) return table[table.length-1].t;
    for(let i=0;i<table.length-1;i++){ const a=table[i], b=table[i+1]; if(psig >= a.p && psig <= b.p){ const f=(psig-a.p)/(b.p-a.p); return a.t + f*(b.t-a.t); } }
    return null;
  }

  function diagnoseAll(d){
    const evapSat = pressureToSatTemp(d.refrig, d.suctionP);
    const condSat = pressureToSatTemp(d.refrig, d.liquidP);
    const superheat = (d.suctionT!=null && evapSat!=null)? d.suctionT - evapSat : null;
    const subcool  = (d.liquidT!=null && condSat!=null)?  condSat - d.liquidT : null;
    const deltaT   = (d.supplyT!=null && d.returnT!=null)? d.returnT - d.supplyT : null;

    let causes = {'Undercharge (low refrigerant)':10,'Overcharge (too much refrigerant)':6,'Restriction — metering device / drier':6,'Low airflow across evaporator':6,'Non-condensables (air in system)':4,'Compressor mechanical issue (valves/leak)':4};
    function add(k,pts){ if(causes[k]!==undefined) causes[k]+=pts; }

    if(superheat!=null && d.targetSH!=null){
      const ds = superheat - d.targetSH;
      if(ds >= 8){ add('Undercharge (low refrigerant)',18); add('Low airflow across evaporator',8); add('Restriction — metering device / drier',6); }
      else if(ds <= -6){ add('Overcharge (too much refrigerant)',18); add('Restriction — metering device / drier',4); }
      else if(Math.abs(ds) >= 4){ add(ds>0?'Undercharge (low refrigerant)':'Overcharge (too much refrigerant)',6); }
    }
    if(subcool!=null && d.targetSC!=null){
      const dc = subcool - d.targetSC;
      if(dc >= 8){ add('Overcharge (too much refrigerant)',16); add('Restriction — metering device / drier',8); }
      else if(dc <= -4){ add('Undercharge (low refrigerant)',14); }
    }
    if(d.suctionP!=null && d.liquidP!=null){
      if(d.suctionP < 105 && d.liquidP < 320) add('Undercharge (low refrigerant)',14);
      if(d.suctionP < 105 && d.liquidP > 380){ add('Low airflow across evaporator',12); add('Non-condensables (air in system)',10); }
      if(d.suctionP > 160 && d.liquidP < 330) add('Compressor mechanical issue (valves/leak)',18);
      if(d.suctionP > 160 && d.liquidP > 480){ add('Overcharge (too much refrigerant)',12); add('Non-condensables (air in system)',10); }
    }
    if(deltaT!=null){ if(deltaT < 12) add('Low airflow across evaporator',18); else if(deltaT > 28) add('Low airflow across evaporator',8); }
    if(d.outdoorDb!=null && d.liquidP!=null){ if(d.outdoorDb > 95 && d.liquidP > 480) add('Non-condensables (air in system)',8); }

    let ranked = Object.keys(causes).map(k=>({cause:k,score:causes[k]})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
    const total = ranked.reduce((s,i)=>s+i.score,0)||1; ranked.forEach(a=>a.pct=Math.round((a.score/total)*100));
    const primary = ranked[0] ? ranked[0] : {cause:'Insufficient data',pct:0};

    let steps = [];
    if(primary.cause.includes('Undercharge')) steps.push('Perform leak check; charge to manufacturer spec using subcooling/superheat targets.');
    if(primary.cause.includes('Overcharge')) steps.push('Recover to target subcool; verify after stabilization and re-check airflow.');
    if(primary.cause.includes('Restriction')) steps.push('Check liquid line drier and TXV/orifice screens; replace any restricted components.');
    if(primary.cause.includes('Low airflow')) steps.push('Verify filter, blower amps, coil cleanliness, and duct dampers; measure CFM if possible.');
    if(primary.cause.includes('Non-condensables')) steps.push('Deep recovery & vacuum; recharge by weight. Watch head pressure behavior.');
    if(primary.cause.includes('Compressor')) steps.push('Check amp draw and consider valve/leak-down tests; verify compression ratio.');

    return {details:{evapSat:round1(evapSat),condSat:round1(condSat),superheat:superheat==null?null:round1(superheat),subcool:subcool==null?null:round1(subcool),deltaT:deltaT==null?null:round1(deltaT)}, ranked, primary, steps};
  }

  function readInputs(){ return {
    refrig: $('refrig').value, systemType: $('systemType').value,
    indoorDb: toNum($('indoorDb').value), indoorWb: toNum($('indoorWb').value), outdoorDb: toNum($('outdoorDb').value),
    targetSH: toNum($('targetSH').value) ?? 10, targetSC: toNum($('targetSC').value) ?? 10,
    suctionP: toNum($('suctionP').value), suctionT: toNum($('suctionT').value),
    liquidP: toNum($('liquidP').value), liquidT: toNum($('liquidT').value),
    supplyT: toNum($('supplyT').value), returnT: toNum($('returnT').value)
  }; }

  function renderResults(r){
    $('primaryFault').textContent = r.primary.cause; $('confPct').textContent = (r.primary.pct||0)+'%';
    $('evapSat').textContent = r.details.evapSat==null?'—':r.details.evapSat+' °F';
    $('condSat').textContent = r.details.condSat==null?'—':r.details.condSat+' °F';
    $('superheat').textContent = r.details.superheat==null?'—':r.details.superheat+' °F';
    $('subcool').textContent = r.details.subcool==null?'—':r.details.subcool+' °F';
    $('deltat').textContent = r.details.deltaT==null?'—':r.details.deltaT+' °F';
    const list=$('causesList'); list.innerHTML='';
    r.ranked.forEach(it=>{ const row=document.createElement('div'); row.className='cause';
      row.innerHTML=`<div>${it.cause}</div><div class="bar"><i style="width:${it.pct}%"></i></div><div style="min-width:48px;text-align:right">${it.pct}%</div>`;
      list.appendChild(row); });
    const ns=$('nextSteps'); ns.innerHTML=''; r.steps.forEach(s=>{ const li=document.createElement('li'); li.textContent=s; ns.appendChild(li); });
  }

  // Inline onclick fallbacks (reliable on Pages)
  window._diagClick = function(){
    const d = readInputs();
    if(d.suctionP==null||d.liquidP==null||d.suctionT==null||d.liquidT==null){ alert('Required: suction pressure, liquid pressure, suction line temp, and liquid line temp. SAT/RAT optional.'); return; }
    const r = diagnoseAll(d);
    renderResults(r);
  };
  window._saveClick = function(){
    const d = readInputs(); const now=new Date();
    const deltaT=(d.supplyT!=null&&d.returnT!=null)?(d.returnT-d.supplyT):null;
    const key='hvac_hist_v1';
    let a=[]; try{ a = JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ a=[]; }
    a.unshift({time:now.toLocaleString(), refrig:d.refrig, suctionP:d.suctionP, suctionT:d.suctionT, liquidP:d.liquidP, liquidT:d.liquidT, deltaT});
    if(a.length>200) a.pop();
    localStorage.setItem(key, JSON.stringify(a));
    alert('Saved to history.');
  };

  // Export/Clear
  document.addEventListener('DOMContentLoaded', function(){
    const exportBtn = $('exportHist');
    const clearBtn = $('clearHist');
    if (exportBtn) exportBtn.addEventListener('click', ()=>{
      let rows=[]; try{ rows = JSON.parse(localStorage.getItem('hvac_hist_v1')||'[]'); }catch(e){ rows=[]; }
      if(rows.length===0){alert('No history to export.'); return;}
      const cols=['time','refrig','suctionP','suctionT','liquidP','liquidT','deltaT'];
      const csv=[cols.join(',')].concat(rows.map(r=>cols.map(c=>r[c]??'').join(','))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='hvac_history.csv'; a.click();
    });
    if (clearBtn) clearBtn.addEventListener('click', ()=>{ if(confirm('Clear all history?')){ localStorage.setItem('hvac_hist_v1','[]'); $('historyList').textContent='No saved readings.'; } });
  });

  // Register service worker
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('/Hvac-troubleshooter-/service-worker.js').catch(()=>{}); }
})();
</script>
</body>
</html>

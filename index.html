<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HVAC Troubleshooter Pro</title>
<link rel="manifest" href="/Hvac-troubleshooter-/manifest.json">
<link rel="icon" href="/Hvac-troubleshooter-/icon-192.png">
<meta name="theme-color" content="#eaf2fb" />
<style>
  :root{ --bg:#f6fafd; --bg2:#ffffff; --panel:#ffffff; --ink:#0a1e2e; --muted:#5a748a; --line:#dfeaf5; --accent:#2f7bff; --cool:#1d9df5; --hot:#ff6a3d; --meter:#31c48d; --soft:#edf4fb; --bad:#b00020; }
  html,body{margin:0;height:100%;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:#0a1e2e}
  .app{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  .logo{width:56px;height:56px;border-radius:16px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 22px rgba(30,100,200,0.12)}
  .logo img{width:40px;height:40px;border-radius:10px}
  h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px}
  .ver{margin-left:6px;padding:2px 6px;border-radius:8px;background:#f0f6ff;border:1px solid var(--line);color:#2b5b7a;font-size:11px;font-weight:800;user-select:none;cursor:default}
  #installBtn{display:none;margin-left:auto;padding:10px 14px;border:0;border-radius:10px;font-weight:800;background:linear-gradient(90deg,#7eb5ff,#a8e0ff);color:#0a1c2a;cursor:pointer;box-shadow:0 6px 14px rgba(62,140,255,0.25)}
  .main{display:grid;grid-template-columns:1.05fr 0.95fr;gap:18px;margin-top:18px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(10,30,50,0.06)}
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .form-grid.two-col{grid-template-columns:1fr 1fr}
  label{display:block;font-size:12px;color:#5a748a;margin-bottom:6px;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
  input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0c263b;font-size:15px}
  input[type=number]{max-width:6.25ch}
  .section-title{font-size:12px;color:#5a748a;margin:6px 0 8px;font-weight:900;text-transform:uppercase;letter-spacing:.08em}
  .btn{padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(90deg,#6fabff,#8fd4ff);color:#0a1c2a;box-shadow:0 8px 16px rgba(111,171,255,0.35)}
  .btn.secondary{background:#f3f8ff;color:#0a1c2a;border:1px solid var(--line)}
  .metric-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .metric{background:var(--soft);border:1px solid var(--line);padding:10px;border-radius:12px;min-width:120px;cursor:pointer}
  .metric .k{font-size:12px;color:#5a748a} .metric .v{font-weight:900}
  .cause{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:#f6fbff;border:1px solid var(--line);margin-top:8px}
  .bar{flex:1;height:10px;background:#e8f2fc;border-radius:6px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--cool),var(--hot))}
  .history{max-height:260px;overflow:auto}
  .hist{display:flex;justify-content:space-between;align-items:center;background:#f9fcff;border:1px solid var(--line);padding:8px;border-radius:10px;margin-top:6px}
  .badge{display:inline-block;margin-left:8px;padding:2px 6px;border-radius:8px;font-size:11px;border:1px solid var(--line);color:#2b5b7a}
  .badge.bad{color:#fff;background:#b00020;border-color:#b00020}
  #stickyActions{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,0),#fff);padding-top:8px}
  .tip{font-size:12px;color:#56728a}
  #whyModal,#coachModal,#playbackModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9999}
  #whyCard,#coachCard,#playbackCard{max-width:900px;margin:6% auto;background:#fff;border-radius:14px;border:1px solid #dfeaf5;padding:14px}
  #coachCard{max-width:720px}
  #playbackCard{max-width:780px}

  #comparePanel { margin-top: 10px; }
  table.compare { width:100%; border-collapse:collapse; font-size:13px }
  table.compare th, table.compare td { border:1px solid var(--line); padding:6px; text-align:center }
  table.compare th { background:#f3f8ff }

  .playback-controls button{margin-right:6px}
  .playback-meta{color:#56728a;font-size:12px;margin-top:6px}

  /* Case ID row with inline button */
  .case-row{display:grid;grid-template-columns:1fr auto;gap:8px}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo"><img src="/Hvac-troubleshooter-/icon-192.png" alt="HV"></div>
    <div>
      <h1>HVAC Troubleshooter — Pro <span id="versionBadge" class="ver">v8.0.5</span> <span id="ptBadge" class="badge">PT: —</span> <span class="badge">Learning: ON</span></h1>
      <div class="tip"><strong>Please use tool to diagnose issues, confirm which diagnosis is correct and click “Send Report” to share data with Administrator.</strong></div>
    </div>
    <button id="installBtn">Install App</button>
  </header>

  <div class="main">
    <div class="panel">
      <div class="section-title">System & Environment</div>
      <div class="form-grid">
        <div>
          <label title="Pulled from /pt/ if present; otherwise a fallback table">Refrigerant</label>
          <select id="refrig"></select>
        </div>
        <div>
          <label title="TXV/EEV: target subcool; Fixed: target superheat">System Type</label>
          <select id="systemType">
            <option value="txv" selected>TXV (subcool)</option>
            <option value="eev">EEV (electronic)</option>
            <option value="fixed">Fixed (superheat)</option>
          </select>
        </div>
        <div><label title="Dry-bulb">Indoor DB (°F)</label><input id="indoorDb" type="number" placeholder="75"></div>
        <div><label title="If available">Indoor WB (°F)</label><input id="indoorWb" type="number" placeholder="63"></div>
        <div><label>Outdoor DB (°F)</label><input id="outdoorDb" type="number" placeholder="95"></div>
        <div><label>Target Superheat (°F)</label><input id="targetSH" type="number" value="10"></div>
        <div><label>Target Subcool (°F)</label><input id="targetSC" type="number" value="10"></div>
      </div>

      <hr style="margin:12px 0;border:0;border-top:1px solid var(--line)">

      <div class="section-title">Refrigerant Cycle</div>
      <div class="panel" style="padding:12px">
        <img id="cycleImg" src="/Hvac-troubleshooter-/assets/refrigeration_cycle_scaled.jpg?v=8.0.5" alt="Refrigerant Cycle" style="width:100%;height:auto;border-radius:12px;border:1px solid var(--line)">
      </div>

      <div class="section-title">Field Readings</div>
      <div class="form-grid">
        <div><label>Suction Pressure (psig)</label><input id="suctionP" type="number" placeholder="118"></div>
        <div><label>Suction Line Temp (°F)</label><input id="suctionT" type="number" placeholder="52"></div>
      </div>

      <div class="section-title">Condenser</div>
      <div class="form-grid two-col">
        <div><label>Liquid Pressure (psig)</label><input id="liquidP" type="number" placeholder="380"></div>
        <div><label>Liquid Line Temp (°F)</label><input id="liquidT" type="number" placeholder="95"></div>
      </div>

      <div class="section-title">Optional — Air Temps</div>
      <div class="form-grid">
        <div><label>Supply Air Temp (°F) — SAT</label><input id="supplyT" type="number" placeholder="optional"></div>
        <div><label>Return Air Temp (°F) — RAT</label><input id="returnT" type="number" placeholder="optional"></div>
        <div><label>Delta T (°F) — manual</label><input id="deltaTManual" type="number" placeholder="optional"></div>
      </div>

      <div class="section-title">Case & Snapshot</div>
      <div class="form-grid two-col">
        <div class="case-row">
          <div>
            <label>Case ID</label>
            <input id="caseId" placeholder="e.g., 25-1004-A">
          </div>
          <div style="align-self:end;">
            <button class="btn secondary" id="newCaseBtn" title="Create new Case ID">New ID</button>
          </div>
        </div>
        <div>
          <label>Snapshot Label</label><input id="snapshotLabelInput" placeholder="T0" value="T0">
        </div>
      </div>

      <div id="stickyActions" style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="btn primary" id="diagBtn">Diagnose</button>
        <button class="btn secondary" id="coachBtn" title="Next-Best-Action coach">Coach</button>
        <button class="btn secondary" id="saveBtn">Save Reading</button>
        <select id="confirmSelect" style="flex:1;min-width:280px;padding:10px;border-radius:12px;border:1px solid var(--line)">
          <option value="">— Optional: Confirm diagnosis (logs to CSV) —</option>
        </select>
        <button class="btn secondary" id="confirmBtn">Confirm</button>
        <button class="btn secondary" id="compareBtn" title="Compare snapshots in this Case ID">Compare Case</button>
        <button class="btn secondary" id="playbackBtn" title="Playback snapshots in this Case ID">Playback</button>
      </div>

      <div id="comparePanel" class="panel" style="display:none;padding:12px">
        <div class="section-title">Case Compare</div>
        <div id="compareSummary" class="tip"></div>
        <div id="compareTableWrap"></div>
      </div>
    </div>

    <aside class="panel">
      <div class="section-title">Diagnosis</div>
      <div class="panel" style="padding:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:12px;color:#5a748a;text-transform:uppercase;font-weight:800">Primary Likely Fault</div>
            <div id="primaryFault" style="font-size:20px;font-weight:900;margin-top:4px">—</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:#5a748a;text-transform:uppercase;font-weight:800">Confidence</div>
            <div id="confPct" style="font-size:22px;font-weight:900;color:#2f7bff">—%</div>
            <button id="whyBtn" class="btn secondary" style="margin-top:6px;padding:6px 10px">Why?</button>
          </div>
        </div>
        <div id="confNote" style="margin-top:4px;color:#5a748a;font-size:12px"></div>
        <div class="metric-row" title="Tap to copy values">
          <div class="metric" data-copy="#evapSat"><div class="k">Evap Sat</div><div class="v" id="evapSat">— °F</div></div>
          <div class="metric" data-copy="#condSat"><div class="k">Cond Sat</div><div class="v" id="condSat">— °F</div></div>
          <div class="metric" data-copy="#superheat"><div class="k">Superheat</div><div class="v" id="superheat">— °F</div></div>
          <div class="metric" data-copy="#subcool"><div class="k">Subcool</div><div class="v" id="subcool">— °F</div></div>
          <div class="metric" data-copy="#deltat"><div class="k">ΔT (RAT−SAT)</div><div class="v" id="deltat">— °F</div></div>
        </div>
        <div id="notes" style="margin-top:8px;color:#5a748a;font-size:13px"></div>
        <div style="margin-top:10px">
          <div style="font-size:12px;color:#5a748a;text-transform:uppercase;font-weight:800">Top Causes</div>
          <div id="causesList" style="margin-top:6px"></div>
        </div>
        <div style="margin-top:10px;font-size:13px;color:#5a748a"><strong>Recommended Next Steps</strong>
          <ul id="nextSteps" style="margin-top:6px"></ul>
        </div>
      </div>

      <div class="section-title" style="margin-top:10px">History</div>
      <div class="panel" style="padding:12px">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:6px">
          <button class="btn secondary" id="sendReportBtn">Send Report</button>
          <button class="btn secondary" id="exportHist">Export History CSV</button>
          <button class="btn secondary" id="clearHist">Clear</button>
        </div>
        <div class="history" id="historyList">No saved readings.</div>
      </div>
    </aside>
  </div>

  <footer style="text-align:center;color:#5a748a;font-size:12px;margin-top:12px">
    Build <strong>v8.0.5</strong> · Case New-ID button · Playback charts restored · Confidence alignment · Excel‑friendly CSV · Full confirm list · PT loader hardened.
  </footer>
</div>

<!-- Reasoning Modal -->
<div id="whyModal">
  <div id="whyCard" role="dialog" aria-modal="true" aria-labelledby="whyTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong id="whyTitle">Why this diagnosis?</strong>
      <button id="whyClose" class="btn secondary" style="padding:6px 10px">Close</button>
    </div>
    <div id="whyContent" style="margin-top:8px;font-size:14px;color:#0a1e2e"></div>
  </div>
</div>

<!-- Coach Modal -->
<div id="coachModal">
  <div id="coachCard" role="dialog" aria-modal="true" aria-labelledby="coachTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong id="coachTitle">Next‑Best‑Action Coach</strong>
      <button id="coachClose" class="btn secondary" style="padding:6px 10px">Close</button>
    </div>
    <div id="coachContent" style="margin-top:8px;font-size:14px;color:#0a1e2e"></div>
  </div>
</div>

<!-- Playback Modal -->
<div id="playbackModal">
  <div id="playbackCard" role="dialog" aria-modal="true" aria-labelledby="playbackTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong id="playbackTitle">Case Playback</strong>
      <button id="playbackClose" class="btn secondary" style="padding:6px 10px">Close</button>
    </div>
    <div class="playback-controls" style="margin-top:8px">
      <button class="btn secondary" id="pbPrev">◀ Prev</button>
      <button class="btn secondary" id="pbPlay">▶ Play</button>
      <button class="btn secondary" id="pbPause" style="display:none">⏸ Pause</button>
      <button class="btn secondary" id="pbNext">Next ▶</button>
      <select id="pbJump" style="margin-left:8px;padding:8px;border-radius:10px;border:1px solid var(--line)"></select>
    </div>
    <div id="playbackMeta" class="playback-meta"></div>
    <div style="margin-top:10px">
      <canvas id="pbChartPress" width="720" height="260" style="width:100%;max-width:720px;border:1px solid var(--line);border-radius:12px;background:#fff"></canvas>
      <div style="height:8px"></div>
      <canvas id="pbChartTemps" width="720" height="260" style="width:100%;max-width:720px;border:1px solid var(--line);border-radius:12px;background:#fff"></canvas>
      <div class="tip" style="margin-top:6px">Pressures scale 0–600 psig; Temps (SH/SC/ΔT) scale 0–60°F. Hover labels show values per snapshot.</div>
    </div>
  </div>
</div>

<script>
(function(){
  const BUILD_ID = '8.0.5';
  const SUBPATH = '/Hvac-troubleshooter-/';
  const $ = (id)=>document.getElementById(id);
  const toNum = (v)=>{ if(v===undefined||v===null||String(v).trim()==='') return null; const n=Number(v); return isNaN(n)?null:n; };
  const round1 = (n)=> n==null?null:Math.round(n*10)/10;

  const BASE_TOL = { sh:4, sc:4, evap:4, dt:5 };
  const TARGETS = { evapSat:40, deltaT:20 };

  const PT_FALLBACK = {
    R410A:[{t:30,p:100},{t:35,p:110},{t:40,p:118},{t:45,p:130},{t:50,p:143},{t:55,p:158},{t:60,p:175}],
    R22:[{t:30,p:56},{t:35,p:61},{t:40,p:66},{t:45,p:72},{t:50,p:78},{t:55,p:85},{t:60,p:92}],
    R32:[{t:30,p:90},{t:35,p:98},{t:40,p:107},{t:45,p:117},{t:50,p:128},{t:55,p:140},{t:60,p:153}],
    R454B:[{t:30,p:88},{t:35,p:96},{t:40,p:105},{t:45,p:115},{t:50,p:126},{t:55,p:138},{t:60,p:151}]
  };
  const PT = {}; const ptMeta = {}; const PT_BADGE = $('ptBadge');

  function timeout(ms){ return new Promise((_,rej)=> setTimeout(()=>rej(new Error('timeout')),ms)); }
  async function getJSON(url){
    try {
      const res = await Promise.race([fetch(url,{cache:'reload'}), timeout(4500)]);
      if(!res || !res.ok) throw new Error('http '+(res && res.status));
      const text = await res.text();
      return JSON.parse(text);
    } catch(e) { throw e; }
  }

  async function initRefrigerants(){
    const sel = $('refrig'); if(!sel) return;
    const defaults = ['R410A','R22','R32','R454B'];
    sel.innerHTML='';
    defaults.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n.replace('R','R-'); sel.appendChild(o); });
    sel.value='R410A';
    if (PT_BADGE){ PT_BADGE.textContent='PT: Fallback'; PT_BADGE.classList.add('bad'); }

    try{
      const idx = await getJSON(SUBPATH+'pt/index.json?v='+BUILD_ID);
      const names = Array.isArray(idx.refrigerants) && idx.refrigerants.length ? idx.refrigerants.map(x=>x.name) : defaults;
      if (names.length) {
        sel.innerHTML='';
        names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n.replace('R','R-'); sel.appendChild(o); });
        sel.value = names.includes('R410A') ? 'R410A' : names[0];
      }
      let csvFound = false;
      for (const item of (idx.refrigerants||[])){
        try{
          const tab = await getJSON(SUBPATH+'pt/'+item.file+'?v='+BUILD_ID);
          if (tab && Array.isArray(tab.table) && tab.table.length){ PT[item.name]=tab.table; ptMeta[item.name]=item.source||'CSV'; csvFound = true; }
        } catch(e){
          const fn = item.name; if(PT_FALLBACK[fn]){ PT[fn]=PT_FALLBACK[fn]; ptMeta[fn]='Fallback'; }
        }
      }
      if (PT_BADGE){ if(csvFound){ PT_BADGE.textContent='PT: CSV'; PT_BADGE.classList.remove('bad'); } else { PT_BADGE.textContent='PT: Fallback'; PT_BADGE.classList.add('bad'); } }
    }catch(e){
      ['R410A','R22','R32','R454B'].forEach(n=>{ if(!PT[n]){ PT[n]=PT_FALLBACK[n]; ptMeta[n]='Fallback'; } });
      if (PT_BADGE){ PT_BADGE.textContent='PT: Fallback'; PT_BADGE.classList.add('bad'); }
    }
  }

  function tFromPsig(ref, psig){
    const tab = PT[ref] || PT_FALLBACK['R410A']; if(!tab || !tab.length || psig==null) return null;
    if(psig <= tab[0].p) return tab[0].t;
    if(psig >= tab[tab.length-1].p) return tab[tab.length-1].t;
    for(let i=0;i<tab.length-1;i++){ const a=tab[i], b=tab[i+1]; if(psig>=a.p && psig<=b.p){ const f=(psig-a.p)/(b.p-a.p); return a.t + f*(b.t-a.t); } }
    return null;
  }

  function computeConfidence(det, d, TOL){
    let score=0,max=0;
    max+=40;
    if(det.superheat!=null && d.targetSH!=null) score += Math.max(0, 24*(1 - Math.min(Math.abs(det.superheat-d.targetSH)/(TOL.sh*2),1)));
    if(det.subcool!=null && d.targetSC!=null)  score += Math.max(0, 24*(1 - Math.min(Math.abs(det.subcool -d.targetSC)/(TOL.sc*2),1)));
    max+=32;
    if(det.deltaT!=null) score += Math.max(0, 22*(1 - Math.min(Math.abs(det.deltaT-TARGETS.deltaT)/(TOL.dt*2),1)));
    else score += 12;
    max+=28;
    if(det.evapSat!=null) score += Math.max(0, 18*(1 - Math.min(Math.abs(det.evapSat-TARGETS.evapSat)/(TOL.evap*2),1)));
    if(det.condSat!=null) score += 10;
    let bonus=0;
    const shNear=(det.superheat!=null && d.targetSH!=null)? Math.abs(det.superheat-d.targetSH)<=Math.max(1,TOL.sh-1):false;
    const scNear=(det.subcool !=null && d.targetSC!=null)? Math.abs(det.subcool -d.targetSC)<=Math.max(1,TOL.sc-1):false;
    const dtNear=(det.deltaT !=null)? Math.abs(det.deltaT - TARGETS.deltaT)<=Math.max(2,TOL.dt-1):false;
    const evNear=(det.evapSat!=null)? Math.abs(det.evapSat - TARGETS.evapSat)<=Math.max(2,TOL.evap-1):false;
    if(shNear) bonus+=6; if(scNear) bonus+=6; if(dtNear) bonus+=6; if(evNear) bonus+=6;
    score += bonus; max += 24;
    return Math.round((score/max)*100);
  }

  function diagnoseAll(d){
    const evapSat = tFromPsig(d.refrig, d.suctionP);
    const condSat = tFromPsig(d.refrig, d.liquidP);
    const superheat = (d.suctionT!=null && evapSat!=null)? d.suctionT - evapSat : null;
    const subcool  = (d.liquidT!=null && condSat!=null)?  condSat - d.liquidT : null;
    let deltaT = null, deltaTSource='—';
    if (d.deltaTManual!=null){ deltaT = d.deltaTManual; deltaTSource='manual'; }
    else if (d.supplyT!=null && d.returnT!=null){ deltaT = d.returnT - d.supplyT; deltaTSource='calc'; }

    const det = {
      evapSat: round1(evapSat), condSat: round1(condSat),
      superheat: superheat==null?null:round1(superheat),
      subcool: subcool==null?null:round1(subcool),
      deltaT: deltaT==null?null:round1(deltaT), deltaTSource
    };

    const causes = {
      'System operating properly':0,
      'Undercharge (low refrigerant)':8,
      'Overcharge (too much refrigerant)':6,
      'Restriction — metering device / drier':6,
      'Low airflow across evaporator':6,
      'Non-condensables (air in system)':4,
      'Compressor mechanical issue (valves/leak)':4,
      'Equipment mismatch (ODU>IDU)':4,
      'TXV overfeeding (adjust superheat)':0,
      'TXV underfeeding (adjust superheat)':0,
      'EEV overfeeding (check control/sensors)':0,
      'EEV underfeeding (check control/sensors)':0
    };

    const rules = [];
    const othersOK = (det.subcool!=null && Math.abs(det.subcool - (d.targetSC??10)) <= BASE_TOL.sc) &&
                     (det.evapSat!=null && Math.abs(det.evapSat - 40) <= BASE_TOL.evap) &&
                     (det.deltaT==null || Math.abs(det.deltaT - 20) <= BASE_TOL.dt);

    if((d.systemType==='txv' || d.systemType==='eev') && det.superheat!=null && d.targetSH!=null && othersOK){
      const shErr = det.superheat - d.targetSH;
      if (shErr < -BASE_TOL.sh){ rules.push('Low SH with SC/Evap/ΔT near target ⇒ overfeeding'); causes[d.systemType==='eev' ? 'EEV overfeeding (check control/sensors)' : 'TXV overfeeding (adjust superheat)'] += 22; }
      else if (shErr > BASE_TOL.sh){ rules.push('High SH with SC/Evap/ΔT near target ⇒ underfeeding'); causes[d.systemType==='eev' ? 'EEV underfeeding (check control/sensors)' : 'TXV underfeeding (adjust superheat)'] += 22; }
    }

    if(det.superheat!=null && d.targetSH!=null){
      const ds = det.superheat - d.targetSH;
      if(ds >= 6){ causes['Undercharge (low refrigerant)'] += 14; causes['Restriction — metering device / drier'] += 6; rules.push('High SH suggests underfeed/undercharge or restriction'); }
      else if(ds <= -6){ causes['Overcharge (too much refrigerant)'] += 12; causes['Restriction — metering device / drier'] += 4; rules.push('Low SH suggests overfeed/overcharge'); }
    }
    if(det.subcool!=null && d.targetSC!=null){
      const dc = det.subcool - d.targetSC;
      if(dc >= 6){ causes['Overcharge (too much refrigerant)'] += 14; causes['Restriction — metering device / drier'] += 6; rules.push('High SC suggests overcharge or condenser flooding'); }
      else if(dc <= -4){ causes['Undercharge (low refrigerant)'] += 12; rules.push('Low SC suggests undercharge or flashing'); }
    }

    if(d.suctionP!=null && d.liquidP!=null){
      if(d.suctionP < 105 && d.liquidP < 320){ causes['Undercharge (low refrigerant)'] += 12; rules.push('Low low-side & low high-side ⇒ likely undercharge'); }
      if(d.suctionP < 105 && d.liquidP > 380){ causes['Low airflow across evaporator'] += 10; causes['Non-condensables (air in system)'] += 8; rules.push('Low suction + high head ⇒ airflow issue or non-condensables'); }
      if(d.suctionP > 160 && d.liquidP < 330){ causes['Compressor mechanical issue (valves/leak)'] += 16; rules.push('High suction + normal/low head ⇒ compressor valves/leak'); }
      if(d.suctionP > 160 && d.liquidP > 480){ causes['Overcharge (too much refrigerant)'] += 10; causes['Non-condensables (air in system)'] += 8; rules.push('High suction + very high head ⇒ overcharge or air'); }
    }

    if(det.deltaT!=null){
      if(det.deltaT < 12){ causes['Low airflow across evaporator'] += 18; rules.push('ΔT < 12°F ⇒ airflow/latent load issue first'); }
      else if(det.deltaT > 28){ causes['Low airflow across evaporator'] += 8; rules.push('ΔT > 28°F ⇒ check airflow / sizing'); }
    }

    let ranked = Object.keys(causes).map(k=>({cause:k,score:causes[k]})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
    const nearOk = (det.evapSat!=null && Math.abs(det.evapSat-40)<=BASE_TOL.evap) &&
                   (det.superheat!=null && d.targetSH!=null && Math.abs(det.superheat-d.targetSH)<=BASE_TOL.sh) &&
                   (det.subcool!=null && d.targetSC!=null && Math.abs(det.subcool-d.targetSC)<=BASE_TOL.sc) &&
                   (det.deltaT==null || Math.abs(det.deltaT-20)<=BASE_TOL.dt);
    if (nearOk) ranked.unshift({cause:'System operating properly', score:100});
    const total = ranked.reduce((s,i)=>s+i.score,0)||1; ranked.forEach(a=>a.pct=Math.round((a.score/total)*100));
    ranked = ranked.slice(0,3);

    const winnerSharePct = ranked[0]?.pct ?? 0;
    const modelConfidence = computeConfidence(det, d, BASE_TOL);
    const primary = ranked[0] ? {cause: ranked[0].cause, pct: winnerSharePct, modelConf: modelConfidence} : {cause:'Insufficient data', pct:0, modelConf:0};
    return {details:det, ranked, primary, rulesFired:rules, input:d};
  }

  function reasoningLines(det, d){
    const lines = [];
    if(det.evapSat!=null) lines.push(`Evap Sat: ${det.evapSat}°F (~40°F)`);
    if(det.condSat!=null) lines.push(`Cond Sat: ${det.condSat}°F`);
    if(det.superheat!=null && d.targetSH!=null) lines.push(`Superheat: ${det.superheat}°F (target ${d.targetSH}°F)`);
    if(det.subcool!=null  && d.targetSC!=null) lines.push(`Subcool: ${det.subcool}°F (target ${d.targetSC}°F)`);
    if(det.deltaT!=null) lines.push(`ΔT (${det.deltaTSource}): ${det.deltaT}°F (target 20°F)`);
    return lines;
  }

  const HIST_KEY='hvac_hist_v7_4b';
  const loadHist=()=>{ try{return JSON.parse(localStorage.getItem(HIST_KEY)||'[]');}catch(e){return []} };
  const saveHist=(a)=> localStorage.setItem(HIST_KEY, JSON.stringify(a));

  function populateConfirmOptions(r){
    const ALL_CAUSES = [
      'System operating properly','Undercharge (low refrigerant)','Overcharge (too much refrigerant)',
      'Restriction — metering device / drier','Low airflow across evaporator','Non-condensables (air in system)',
      'Compressor mechanical issue (valves/leak)','Equipment mismatch (ODU>IDU)',
      'TXV overfeeding (adjust superheat)','TXV underfeeding (adjust superheat)',
      'EEV overfeeding (check control/sensors)','EEV underfeeding (check control/sensors)'
    ];
    const sel = $('confirmSelect'); if(!sel) return;
    const keep = sel.value;
    sel.innerHTML='';
    const optBlank = document.createElement('option'); optBlank.value=''; optBlank.textContent='— Optional: Confirm diagnosis (logs to CSV) —'; sel.appendChild(optBlank);
    const seen = new Set();
    const add = (label)=>{ if(!label || seen.has(label)) return; seen.add(label); const o=document.createElement('option'); o.value=label; o.textContent=label; sel.appendChild(o); };
    if (r && r.primary && r.primary.cause) add(r.primary.cause);
    if (r && Array.isArray(r.ranked)) r.ranked.forEach(x=> add(x.cause));
    ALL_CAUSES.forEach(add);
    sel.value = keep || '';
  }

  function renderResults(r){
    const pf=$('primaryFault'), cp=$('confPct'), note=$('confNote');
    if (pf) pf.textContent = r.primary.cause;
    if (cp) { let conf=r.primary.pct||0; if(r.primary.cause.toLowerCase().includes('operating properly') && conf<95) conf=95; cp.textContent = conf+'%'; }
    if (note) {
      const lines = [];
      if (r.details.deltaT==null) lines.push('ΔT missing (enter manual or SAT/RAT)');
      else lines.push(r.details.deltaTSource==='manual' ? 'ΔT provided by tech' : 'ΔT computed from SAT/RAT');
      if (r.details.superheat!=null && r.input.targetSH!=null && Math.abs(r.details.superheat-r.input.targetSH)<=BASE_TOL.sh) lines.push('SH near target');
      if (r.details.subcool!=null && r.input.targetSC!=null && Math.abs(r.details.subcool-r.input.targetSC)<=BASE_TOL.sc) lines.push('SC near target');
      if (r.details.evapSat!=null && Math.abs(r.details.evapSat-40)<=BASE_TOL.evap) lines.push('Evap sat near 40°F');
      lines.push('Model confidence: '+(r.primary.modelConf||0)+'%');
      note.textContent = lines.join(' • ');
    }
    const set = (id,val)=>{ const el=$(id); if(el) el.textContent = (val==null?'—':val+' °F'); };
    set('evapSat', r.details.evapSat); set('condSat', r.details.condSat); set('superheat', r.details.superheat); set('subcool', r.details.subcool);
    const dtEl=$('deltat'); if(dtEl) dtEl.textContent = (r.details.deltaT==null?'—':r.details.deltaT+' °F');

    const list=$('causesList'); if(list){ list.innerHTML='';
      const nums = reasoningLines(r.details, r.input);
      r.ranked.forEach(it=>{
        const row=document.createElement('div'); row.className='cause';
        const why = document.createElement('details');
        const bullets = nums.map(s=>`<li>${s}</li>`).join('');
        why.innerHTML = `<summary>${it.cause} — ${it.pct}%</summary><ul style="margin:6px 0 0 18px">${bullets}</ul>`;
        row.appendChild(why);
        const bar=document.createElement('div'); bar.className='bar'; bar.innerHTML=`<i style="width:${Math.max(6, it.pct)}%"></i>`; row.appendChild(bar);
        list.appendChild(row);
      });
    }
    populateConfirmOptions(r);
  }

  function currentSnapshotLabel(){ const i=$('snapshotLabelInput'); return (i && i.value.trim())?i.value.trim():'T0'; }

  function ensureOption(selectEl, value){
    if (!selectEl) return;
    const exists = Array.from(selectEl.options).some(o=>o.value===value);
    if (!exists){ const o=document.createElement('option'); o.value=value; o.textContent=value.replace('R','R-'); selectEl.appendChild(o); }
  }

  function readInputs(){
    return {
      refrig: ($('refrig')||{}).value || 'R410A', systemType: ($('systemType')||{}).value || 'txv',
      indoorDb: toNum(($('indoorDb')||{}).value), indoorWb: toNum(($('indoorWb')||{}).value), outdoorDb: toNum(($('outdoorDb')||{}).value),
      targetSH: toNum(($('targetSH')||{}).value) ?? 10, targetSC: toNum(($('targetSC')||{}).value) ?? 10,
      suctionP: toNum(($('suctionP')||{}).value), suctionT: toNum(($('suctionT')||{}).value),
      liquidP: toNum(($('liquidP')||{}).value), liquidT: toNum(($('liquidT')||{}).value),
      supplyT: toNum(($('supplyT')||{}).value), returnT: toNum(($('returnT')||{}).value),
      deltaTManual: toNum(($('deltaTManual')||{}).value),
      caseId: (($('caseId')||{}).value||'').trim(),
      snapshotLabel: currentSnapshotLabel()
    };
  }

  function applySnapshotToForm(s){
    const setVal = (id, val)=>{ const el=$(id); if(el!=null && val!=null) el.value = String(val); };
    if (s.refrig) ensureOption($('refrig'), s.refrig);
    setVal('refrig', s.refrig);
    setVal('systemType', s.systemType);
    setVal('indoorDb', s.indoorDb); setVal('indoorWb', s.indoorWb); setVal('outdoorDb', s.outdoorDb);
    setVal('targetSH', s.targetSH); setVal('targetSC', s.targetSC);
    setVal('suctionP', s.suctionP); setVal('suctionT', s.suctionT);
    setVal('liquidP', s.liquidP);  setVal('liquidT', s.liquidT);
    setVal('supplyT', s.supplyT);   setVal('returnT', s.returnT);
    setVal('deltaTManual', s.deltaT);
    const sl = $('snapshotLabelInput'); if (sl) sl.value = s.snapshotLabel || sl.value || 'T0';
    const ci = $('caseId'); if (ci) ci.value = s.caseId || ci.value || '';
    const d=readInputs(); const r=diagnoseAll(d); renderResults(r);
  }

  function renderHist(){
    const list=$('historyList'); const a=loadHist(); if(!list) return;
    if(a.length===0){ list.textContent='No saved readings.'; return; }
    list.innerHTML='';
    a.forEach((h,i)=>{
      const d=document.createElement('div'); d.className='hist';
      d.innerHTML = `<div><strong>${h.refrig||''}</strong> · ${h.time||''} · <em>${h.caseId||'—'}/${h.snapshotLabel||'—'}</em><br><span style="color:#5a748a;font-size:12px">SP:${h.suctionP||''} ST:${h.suctionT||''} · LP:${h.liquidP||''} LT:${h.liquidT||''} · ΔT:${h.deltaT??'—'} (${h.deltaTSource||'—'}) · ${h.actualDiagnosis || h.suggestedDiagnosis || ''} · Conf:${h.confPct||0}%</span></div>`;
      const del=document.createElement('button'); del.textContent='Del'; del.className='btn secondary'; del.style.padding='6px'; del.style.borderRadius='8px';
      del.onclick=()=>{ const x=loadHist(); x.splice(i,1); saveHist(x); renderHist(); };
      d.appendChild(del); list.appendChild(d);
    });
  }

  function buildCompareTable(rows){
    const cols = [
      ['snapshot','Snapshot'],
      ['time','Time'],
      ['suctionP','Suction P (psig)'],
      ['liquidP','Liquid P (psig)'],
      ['evapSat','Evap Sat (°F)'],
      ['condSat','Cond Sat (°F)'],
      ['superheat','Superheat (°F)'],
      ['subcool','Subcool (°F)'],
      ['deltaT','ΔT (°F)'],
      ['suggestedDiagnosis','Suggested'],
      ['actualDiagnosis','Confirmed'],
      ['confPct','Conf (%)']
    ];
    const header = '<tr>' + cols.map(c=>`<th>${c[1]}</th>`).join('') + '</tr>';
    const body = rows.map(r=>{
      const snap = r.snapshotLabel || '—';
      const vals = {
        snapshot: snap,
        time: r.time || '—',
        suctionP: r.suctionP ?? '—',
        liquidP: r.liquidP ?? '—',
        evapSat: r.evapSat ?? '—',
        condSat: r.condSat ?? '—',
        superheat: r.superheat ?? '—',
        subcool: r.subcool ?? '—',
        deltaT: r.deltaT ?? '—',
        suggestedDiagnosis: r.suggestedDiagnosis || '—',
        actualDiagnosis: r.actualDiagnosis || '—',
        confPct: r.confPct ?? '—'
      };
      return '<tr>' + cols.map(c=>`<td>${vals[c[0]]}</td>`).join('') + '</tr>';
    }).join('');
    return '<table class="compare">'+header+body+'</table>';
  }

  // Simple canvas plotting helpers
  function drawGrid(ctx, w, h, xPad, yPad, yMax, yStep, label){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#0a1e2e'; ctx.font = '12px Inter, system-ui, Arial';
    ctx.fillText(label, 8, 16);
    ctx.strokeStyle = '#dfeaf5'; ctx.lineWidth = 1;
    for (let y=0; y<=yMax; y+=yStep) {
      const yy = h - yPad - (y / yMax) * (h - 2*yPad);
      ctx.beginPath(); ctx.moveTo(xPad, yy); ctx.lineTo(w - xPad/2, yy); ctx.stroke();
      ctx.fillStyle = '#56728a'; ctx.fillText(String(y), 6, yy - 2);
    }
  }
  function plotSeries(ctx, w, h, xPad, yPad, yMax, values, color, label, xLabels){
    const n = values.length; if (!n) return;
    const xStep = (w - 2*xPad) / Math.max(1, n-1);
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
    values.forEach((v,i)=>{
      if (v==null) return;
      const x = xPad + i * xStep;
      const y = h - yPad - Math.max(0, Math.min(1, v / yMax)) * (h - 2*yPad);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    ctx.fillStyle = color;
    values.forEach((v,i)=>{
      if (v==null) return;
      const x = xPad + i * xStep;
      const y = h - yPad - Math.max(0, Math.min(1, v / yMax)) * (h - 2*yPad);
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    });
    // X labels
    ctx.fillStyle = '#56728a'; ctx.font = '11px Inter, system-ui, Arial';
    xLabels.forEach((lbl,i)=>{
      const x = xPad + i * xStep; ctx.fillText(lbl, x-12, h-6);
    });
    // Legend
    ctx.fillStyle = color; ctx.fillRect(w-140, 10, 10, 10);
    ctx.fillStyle = '#0a1e2e'; ctx.fillText(label, w-125, 20);
  }

  // Playback globals
  let pbTimer = null; let pbIndex = 0; let pbRows = [];

  function refreshPlaybackCharts(){
    const press = document.getElementById('pbChartPress'); const tctx = press.getContext('2d');
    const temps = document.getElementById('pbChartTemps'); const uctx = temps.getContext('2d');
    const w = press.width, h = press.height; const xPad=40, yPad=26;
    const labels = pbRows.map(r=> (r.snapshotLabel || '').toString());
    const suction = pbRows.map(r=> r.suctionP!=null? Number(r.suctionP): null);
    const liquid  = pbRows.map(r=> r.liquidP!=null?  Number(r.liquidP):  null);
    const sh = pbRows.map(r=> r.superheat!=null? Number(r.superheat): null);
    const sc = pbRows.map(r=> r.subcool!=null?  Number(r.subcool):  null);
    const dt = pbRows.map(r=> r.deltaT!=null?   Number(r.deltaT):   null);

    drawGrid(tctx, w, h, xPad, yPad, 600, 100, 'Pressures (psig)');
    plotSeries(tctx, w, h, xPad, yPad, 600, suction, '#1d9df5', 'Suction', labels);
    plotSeries(tctx, w, h, xPad, yPad, 600, liquid,  '#ff6a3d', 'Liquid', labels);

    drawGrid(uctx, w, h, xPad, yPad, 60, 10, 'Temps (°F)');
    plotSeries(uctx, w, h, xPad, yPad, 60, sh, '#2f7bff', 'Superheat', labels);
    plotSeries(uctx, w, h, xPad, yPad, 60, sc, '#31c48d', 'Subcool', labels);
    plotSeries(uctx, w, h, xPad, yPad, 60, dt, '#7d5bed', 'ΔT', labels);
  }

  function showSnapshot(i){
    if (!pbRows.length) return;
    if (i<0) i=pbRows.length-1; if (i>=pbRows.length) i=0;
    pbIndex = i; const s = pbRows[pbIndex];
    $('pbJump').value = String(pbIndex);
    $('playbackMeta').textContent = `Snapshot ${pbIndex+1}/${pbRows.length} — ${s.snapshotLabel||'—'} — ${s.time||''}`;
    applySnapshotToForm(s);
    refreshPlaybackCharts();
  }

  function openPlayback(){
    const caseInput = ($('caseId')||{}).value||'';
    if (!caseInput.trim()){ alert('Enter a Case ID first.'); return; }
    const all = loadHist().filter(r=> (r.caseId||'').trim() === caseInput.trim());
    if (!all.length){ alert('No snapshots saved for this Case ID yet.'); return; }
    const labelOrder = {'t0':0,'t+10':1,'t+20':2,'T0':0,'T+10':1,'T+20':2};
    all.sort((a,b)=> (labelOrder[a.snapshotLabel]??99) - (labelOrder[b.snapshotLabel]??99) || (new Date(a.time)-new Date(b.time)));
    pbRows = all; pbIndex = 0;
    const jump = $('pbJump'); jump.innerHTML = '';
    pbRows.forEach((r,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=(r.snapshotLabel||'—')+' — '+(r.time||''); jump.appendChild(o); });
    $('playbackMeta').textContent = `Loaded ${pbRows.length} snapshot(s) for Case ${caseInput}`;
    $('playbackModal').style.display='block';
    wirePlaybackControls();
    showSnapshot(0);
  }

  function wirePlaybackControls(){
    $('pbPrev').onclick = ()=> showSnapshot(pbIndex-1);
    $('pbNext').onclick = ()=> showSnapshot(pbIndex+1);
    $('pbPlay').onclick = ()=> startPlayback();
    $('pbPause').onclick = ()=> stopPlayback();
    $('pbJump').onchange = (e)=> showSnapshot(parseInt(e.target.value,10)||0);
  }

  function startPlayback(){
    if (pbTimer) return;
    $('pbPlay').style.display='none'; $('pbPause').style.display='inline-block';
    pbTimer = setInterval(()=> showSnapshot(pbIndex+1), 1800);
  }
  function stopPlayback(){
    if (!pbTimer) return; clearInterval(pbTimer); pbTimer=null;
    $('pbPause').style.display='none'; $('pbPlay').style.display='inline-block';
  }

  function newCaseId(){
    const d = new Date();
    const y = String(d.getFullYear()).slice(-2);
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const rand = Math.floor(Math.random()*900)+100; // 3-digit
    return `${y}-${m}${day}-${rand}`;
  }

  function initButtons(){
    const diagBtn=$('diagBtn'); if(diagBtn) diagBtn.addEventListener('click', ()=>{ const d=readInputs(); if(d.suctionP==null||d.liquidP==null||d.suctionT==null||d.liquidT==null){ alert('Required: suction pressure, liquid pressure, suction line temp, and liquid line temp.'); return; } const r=diagnoseAll(d); renderResults(r); });

    const saveBtn=$('saveBtn'); if(saveBtn) saveBtn.addEventListener('click', ()=>{
      const d=readInputs(); if(d.suctionP==null||d.liquidP==null||d.suctionT==null||d.liquidT==null){ alert('Enter required values before saving.'); return; }
      const r=diagnoseAll(d);
      const entry = {
        time: new Date().toLocaleString(), appVersion:'v8.0.5', refrig:d.refrig, systemType:d.systemType,
        indoorDb:d.indoorDb, indoorWb:d.indoorWb, outdoorDb:d.outdoorDb, targetSH:d.targetSH, targetSC:d.targetSC,
        suctionP:d.suctionP, suctionT:d.suctionT, liquidP:d.liquidP, liquidT:d.liquidT, supplyT:d.supplyT, returnT:d.returnT,
        evapSat:r.details.evapSat, condSat:r.details.condSat, superheat:r.details.superheat, subcool:r.details.subcool, deltaT:r.details.deltaT, deltaTSource:r.details.deltaTSource,
        suggestedDiagnosis:r.primary.cause, actualDiagnosis:'', confPct:r.primary.pct, learningOn:true, testerInitials:'',
        rulesFired:(r.rulesFired||[]).join(' | '),
        caseId: d.caseId || '', snapshotLabel: d.snapshotLabel || 'T0'
      };
      const a=loadHist(); a.unshift(entry); if(a.length>1000) a.pop(); saveHist(a); alert('Saved to history.'); renderHist();
    });

    const exportBtn=$('exportHist'); if(exportBtn) exportBtn.addEventListener('click', ()=>{
      const rows=loadHist(); if(rows.length===0){alert('No history to export.'); return;}
      const esc=(v)=>{ if(v==null) return ''; const s=String(v); return /[",\r\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s; };
      const order=["time","appVersion","caseId","snapshotLabel","refrig","systemType","indoorDb","indoorWb","outdoorDb","targetSH","targetSC","suctionP","suctionT","liquidP","liquidT","supplyT","returnT","deltaT","deltaTSource","evapSat","condSat","superheat","subcool","suggestedDiagnosis","actualDiagnosis","confPct","learningOn","testerInitials","rulesFired"];
      const header=order.join(','); const body=rows.map(r=>order.map(k=>esc(r[k])).join(',')).join('\r\n'); const csv='\ufeff'+header+'\r\n'+body;
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='hvac_history_v8_0_5.csv'; a.click();
    });

    const clearBtn=$('clearHist'); if(clearBtn) clearBtn.addEventListener('click', ()=>{ if(confirm('Clear all history?')){ localStorage.removeItem(HIST_KEY); renderHist(); } });

    const confirmBtn = $('confirmBtn');
    if (confirmBtn) confirmBtn.addEventListener('click', ()=>{
      const sel = $('confirmSelect'); if (!sel || !sel.value) { alert('Choose a diagnosis to confirm.'); return; }
      const d=readInputs(); const r=diagnoseAll(d);
      const entry = { time: new Date().toLocaleString(), appVersion:'v8.0.5', refrig:d.refrig, systemType:d.systemType,
        indoorDb:d.indoorDb, indoorWb:d.indoorWb, outdoorDb:d.outdoorDb, targetSH:d.targetSH, targetSC:d.targetSC,
        suctionP:d.suctionP, suctionT:d.suctionT, liquidP:d.liquidP, liquidT:d.liquidT, supplyT:d.supplyT, returnT:d.returnT,
        evapSat:r.details.evapSat, condSat:r.details.condSat, superheat:r.details.superheat, subcool:r.details.subcool, deltaT:r.details.deltaT, deltaTSource:r.details.deltaTSource,
        suggestedDiagnosis:r.primary.cause, actualDiagnosis: sel.value, confPct:r.primary.pct, learningOn:true, testerInitials:'', rulesFired:(r.rulesFired||[]).join(' | '),
        caseId: d.caseId || '', snapshotLabel: d.snapshotLabel || 'T0' };
      const a=loadHist(); a.unshift(entry); if(a.length>1000) a.pop(); saveHist(a); renderHist(); alert('Confirmation recorded.');
    });

    const compareBtn = $('compareBtn');
    if (compareBtn) compareBtn.addEventListener('click', ()=>{
      const caseInput = ($('caseId')||{}).value||'';
      if (!caseInput.trim()){ alert('Enter a Case ID first.'); return; }
      const all = loadHist().filter(r=> (r.caseId||'').trim() === caseInput.trim());
      if (!all.length){ alert('No snapshots saved for this Case ID yet.'); return; }
      const labelOrder = {'t0':0,'t+10':1,'t+20':2,'T0':0,'T+10':1,'T+20':2};
      all.sort((a,b)=> (labelOrder[a.snapshotLabel]??99) - (labelOrder[b.snapshotLabel]??99) || (new Date(a.time)-new Date(b.time)));
      const html = buildCompareTable(all);
      $('compareTableWrap').innerHTML = html;
      $('compareSummary').textContent = `Comparing ${all.length} snapshot(s) for Case ${caseInput}`;
      $('comparePanel').style.display='block';
    });

    const playbackBtn = $('playbackBtn');
    if (playbackBtn) playbackBtn.addEventListener('click', ()=> openPlayback());

    const pbModal = $('playbackModal'); const pbClose = $('playbackClose');
    if (pbModal && pbClose) { 
      pbClose.onclick = ()=> pbModal.style.display='none';
      pbModal.onclick = (e)=>{ if(e.target===pbModal) pbModal.style.display='none'; };
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && pbModal.style.display==='block') pbModal.style.display='none'; });
    }

    const whyModal = $('whyModal'), whyClose = $('whyClose');
    if (whyModal && whyClose){ 
      whyClose.onclick = ()=> whyModal.style.display='none';
      whyModal.onclick = (e)=>{ if(e.target===whyModal) whyModal.style.display='none'; };
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && whyModal.style.display==='block') whyModal.style.display='none'; });
    }

    // New Case ID button
    const newCaseBtn = $('newCaseBtn');
    if (newCaseBtn) { newCaseBtn.onclick = ()=>{ const id=newCaseId(); const ci=$('caseId'); if(ci) ci.value=id; }; }

    // Coach
    const coachBtn = $('coachBtn');
    if (coachBtn) coachBtn.onclick = ()=>{ const d=readInputs(); if(d.suctionP==null||d.liquidP==null||d.suctionT==null||d.liquidT==null){ alert('Enter the four required readings first.'); return; }
      const r=diagnoseAll(d); openCoach(r); };
  }

  function openCoach(r){
    const labels = r.ranked.map(c=>c.cause);
    const scores = r.ranked.map(c=>c.pct/100);
    const mx = Math.max(...scores, 0); const ex = scores.map(s=>Math.exp(s-mx)); const sum = ex.reduce((a,b)=>a+b,0)||1; const probs = ex.map(v=>v/sum);
    const actions = [
      { id:'check_airflow', label:'Measure evap airflow (CFM) or increase fan 10%', targets:['Low airflow across evaporator'] },
      { id:'bleed_air', label:'Purge test for trapped air', targets:['Non-condensables (air in system)'] },
      { id:'weigh_charge', label:'Weigh charge ±4–8 oz & observe SH/SC', targets:['Undercharge (low refrigerant)','Overcharge (too much refrigerant)','Restriction — metering device / drier'] },
      { id:'txv_screen', label:'Inspect TXV inlet screen / bulb placement', targets:['Restriction — metering device / drier','TXV underfeeding (adjust superheat)'] },
      { id:'condenser_coil', label:'Check condenser fan/coil cleanliness', targets:['Condenser airflow failure (fan out / slow)'] }
    ];
    function H(lambda){ return -lambda.reduce((s,q)=> s + (q>0?q*Math.log2(q):0),0); }
    function expGain(a){
      const set=new Set(a.targets||[]);
      const imp=probs.map((p,i)=> set.has(labels[i]) ? p*1.35 : p*0.85);
      const n=imp.reduce((x,y)=>x+y,0)||1; for(let i=0;i<imp.length;i++) imp[i]/=n;
      return (H(probs) - (0.7*H(imp) + 0.3*H(probs)));
    }
    const ranked = actions.map(a=>({a, g:expGain(a)})).sort((x,y)=>y.g-x.g).slice(0,3);
    const el = document.getElementById('coachContent'); const modal = document.getElementById('coachModal');
    el.innerHTML = '<ul style="margin:0;padding-left:18px">' + ranked.map(function(i){ return '<li><strong>'+i.a.label+'</strong> — info gain '+(i.g*100).toFixed(1)+'%</li>'; }).join('') + '</ul>';
    modal.style.display='block';
  }

  // Boot
  async function boot(){ await initRefrigerants(); renderHist(); initButtons(); }
  boot();
})();
</script>
<script src="./send-report.v81.js?v=3"></script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HVAC Troubleshooter Pro</title>
<link rel="manifest" href="/Hvac-troubleshooter-/manifest.json">
<link rel="icon" href="/Hvac-troubleshooter-/icon-192.png">
<meta name="theme-color" content="#eaf2fb" />
<style>
  :root{ --bg:#f6fafd; --bg2:#ffffff; --panel:#ffffff; --ink:#0a1e2e; --muted:#5a748a; --line:#dfeaf5; --accent:#2f7bff; --cool:#1d9df5; --hot:#ff6a3d; --meter:#31c48d; --soft:#edf4fb; --bad:#b00020; }
  html,body{margin:0;height:100%;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:#0a1e2e}
  .app{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  .logo{width:56px;height:56px;border-radius:16px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 22px rgba(30,100,200,0.12)}
  .logo img{width:40px;height:40px;border-radius:10px}
  h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px}
  .ver{margin-left:6px;padding:2px 6px;border-radius:8px;background:#f0f6ff;border:1px solid var(--line);color:#2b5b7a;font-size:11px;font-weight:800;user-select:none;cursor:default}
  #installBtn{display:none;margin-left:auto;padding:10px 14px;border:0;border-radius:10px;font-weight:800;background:linear-gradient(90deg,#7eb5ff,#a8e0ff);color:#0a1c2a;cursor:pointer;box-shadow:0 6px 14px rgba(62,140,255,0.25)}
  .main{display:grid;grid-template-columns:1.05fr 0.95fr;gap:18px;margin-top:18px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(10,30,50,0.06)}
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .form-grid.two-col{grid-template-columns:1fr 1fr}
  label{display:block;font-size:12px;color:#5a748a;margin-bottom:6px;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
  input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0c263b;font-size:15px}
  input[type=number]{max-width:6.25ch}
  .section-title{font-size:12px;color:#5a748a;margin:6px 0 8px;font-weight:900;text-transform:uppercase;letter-spacing:.08em}
  .btn{padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(90deg,#6fabff,#8fd4ff);color:#0a1c2a;box-shadow:0 8px 16px rgba(111,171,255,0.35)}
  .btn.secondary{background:#f3f8ff;color:#0a1c2a;border:1px solid var(--line)}
  .metric-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .metric{background:var(--soft);border:1px solid var(--line);padding:10px;border-radius:12px;min-width:120px;cursor:pointer}
  .metric .k{font-size:12px;color:#5a748a} .metric .v{font-weight:900}
  .cause{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:#f6fbff;border:1px solid var(--line);margin-top:8px}
  .bar{flex:1;height:10px;background:#e8f2fc;border-radius:6px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--cool),var(--hot))}
  .history{max-height:240px;overflow:auto}
  .hist{display:flex;justify-content:space-between;align-items:center;background:#f9fcff;border:1px solid var(--line);padding:8px;border-radius:10px;margin-top:6px}
  .badge{display:inline-block;margin-left:8px;padding:2px 6px;border-radius:8px;font-size:11px;border:1px solid var(--line);color:#2b5b7a}
  .badge.bad{color:#fff;background:#b00020;border-color:#b00020}
  #stickyActions{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,0),#fff);padding-top:8px}
  .tip{font-size:12px;color:#56728a}
  #whyModal,#compareModal,#replayModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9999}
  #whyCard,#compareCard,#replayCard{max-width:900px;margin:4% auto;background:#fff;border-radius:14px;border:1px solid #dfeaf5;padding:14px}
  #coachBtn{margin-left:4px}
  footer .notes {max-width: 980px; margin: 0 auto;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <div class="logo"><img src="/Hvac-troubleshooter-/icon-192.png" alt="HV"></div>
    <div>
      <h1>HVAC Troubleshooter — Pro <span id="versionBadge" class="ver">v8.0.0</span> <span id="ptBadge" class="badge">PT: —</span> <span class="badge">Learning: ON</span></h1>
      <div class="tip"><strong>Please use tool to diagnose issues, confirm which diagnosis is correct and click “Send Report” to share data with Administrator.</strong></div>
    </div>
    <button id="installBtn">Install App</button>
  </header>

  <div class="main">
    <div class="panel">
      <div class="section-title">System & Environment</div>
      <div class="form-grid">
        <div>
          <label title="Pulled from /pt/ if present; otherwise a fallback table">Refrigerant</label>
          <select id="refrig"></select>
        </div>
        <div>
          <label title="TXV/EEV: target subcool; Fixed: target superheat">System Type</label>
          <select id="systemType">
            <option value="txv" selected>TXV (subcool)</option>
            <option value="eev">EEV (electronic)</option>
            <option value="fixed">Fixed (superheat)</option>
          </select>
        </div>
        <div><label title="Dry-bulb">Indoor DB (°F)</label><input id="indoorDb" type="number" placeholder="75"></div>
        <div><label title="If available">Indoor WB (°F)</label><input id="indoorWb" type="number" placeholder="63"></div>
        <div><label>Outdoor DB (°F)</label><input id="outdoorDb" type="number" placeholder="95"></div>
        <div><label>Target Superheat (°F)</label><input id="targetSH" type="number" value="10"></div>
        <div><label>Target Subcool (°F)</label><input id="targetSC" type="number" value="10"></div>
        <div>
          <label>Case ID</label>
          <div style="display:flex;gap:8px">
            <input id="caseId" type="text" placeholder="auto" style="flex:1">
            <button class="btn secondary" id="genCase">New</button>
          </div>
        </div>
        <div>
          <label>Snapshot Label</label>
          <input id="snapshotLabel" type="text" placeholder="T0">
        </div>
      </div>

      <hr style="margin:12px 0;border:0;border-top:1px solid var(--line)">

      <div class="section-title">Refrigerant Cycle</div>
      <div class="panel" style="padding:12px">
        <img id="cycleImg" src="/Hvac-troubleshooter-/assets/refrigeration_cycle_scaled.jpg?v=8.0.0" alt="Refrigerant Cycle" style="width:100%;height:auto;border-radius:12px;border:1px solid var(--line)">
      </div>

      <div class="section-title">Field Readings</div>
      <div class="form-grid">
        <div><label>Suction Pressure (psig)</label><input id="suctionP" type="number" placeholder="118"></div>
        <div><label>Suction Line Temp (°F)</label><input id="suctionT" type="number" placeholder="52"></div>
      </div>

      <div class="section-title">Condenser</div>
      <div class="form-grid two-col">
        <div><label>Liquid Pressure (psig)</label><input id="liquidP" type="number" placeholder="380"></div>
        <div><label>Liquid Line Temp (°F)</label><input id="liquidT" type="number" placeholder="95"></div>
      </div>

      <div class="section-title">Optional — Air Temps</div>
      <div class="form-grid">
        <div><label>Supply Air Temp (°F) — SAT</label><input id="supplyT" type="number" placeholder="optional"></div>
        <div><label>Return Air Temp (°F) — RAT</label><input id="returnT" type="number" placeholder="optional"></div>
        <div><label>Delta T (°F) — manual</label><input id="deltaTManual" type="number" placeholder="optional"></div>
      </div>

      <div id="stickyActions" style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="btn primary" id="diagBtn">Diagnose</button>
        <button class="btn secondary" id="coachBtn" title="Next-Best-Action coach">Coach</button>
        <button class="btn secondary" id="saveBtn">Save Reading</button>
        <select id="confirmSelect" style="flex:1;min-width:280px;padding:10px;border-radius:12px;border:1px solid var(--line)">
          <option value="">— Optional: Confirm diagnosis (logs to CSV) —</option>
        </select>
        <button class="btn secondary" id="confirmBtn">Confirm</button>
        <button class="btn secondary" id="compareBtn" title="Compare snapshots in this Case">Compare</button>
        <button class="btn secondary" id="replayBtn" title="Smart Replay: animated charts">Replay</button>
        <button class="btn secondary" id="simulateBtn" title="What-If Simulator (coming soon)" disabled>Simulate</button>
      </div>
    </div>

    <aside class="panel">
      <div class="section-title">Diagnosis</div>
      <div class="panel" style="padding:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:12px;color:#5a748a;text-transform:uppercase;font-weight:800">Primary Likely Fault</div>
            <div id="primaryFault" style="font-size:20px;font-weight:900;margin-top:4px">—</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:#5a748a;text-transform:uppercase;font-weight:800">Confidence</div>
            <div id="confPct" style="font-size:22px;font-weight:900;color:#2f7bff">—%</div>
            <button id="whyBtn" class="btn secondary" style="margin-top:6px;padding:6px 10px">Why?</button>
          </div>
        </div>
        <div id="confNote" style="margin-top:4px;color:#5a748a;font-size:12px"></div>
        <div class="metric-row" title="Tap to copy values">
          <div class="metric" data-copy="#evapSat"><div class="k">Evap Sat</div><div class="v" id="evapSat">— °F</div></div>
          <div class="metric" data-copy="#condSat"><div class="k">Cond Sat</div><div class="v" id="condSat">— °F</div></div>
          <div class="metric" data-copy="#superheat"><div class="k">Superheat</div><div class="v" id="superheat">— °F</div></div>
          <div class="metric" data-copy="#subcool"><div class="k">Subcool</div><div class="v" id="subcool">— °F</div></div>
          <div class="metric" data-copy="#deltat"><div class="k">ΔT (RAT−SAT)</div><div class="v" id="deltat">— °F</div></div>
        </div>
        <div id="notes" style="margin-top:8px;color:#5a748a;font-size:13px"></div>
        <div style="margin-top:10px">
          <div style="font-size:12px;color:#5a748a;text-transform:uppercase;font-weight:800">Top Causes</div>
          <div id="causesList" style="margin-top:6px"></div>
        </div>
        <div style="margin-top:10px;font-size:13px;color:#5a748a"><strong>Recommended Next Steps</strong>
          <ul id="nextSteps" style="margin-top:6px"></ul>
        </div>
      </div>

      <div class="section-title" style="margin-top:10px">History</div>
      <div class="panel" style="padding:12px">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:6px">
          <button class="btn secondary" id="sendReportBtn">Send Report</button>
          <button class="btn secondary" id="exportHist">Export History CSV</button>
          <button class="btn secondary" id="clearHist">Clear</button>
        </div>
        <div class="history" id="historyList">No saved readings.</div>
      </div>
    </aside>
  </div>

  <footer style="text-align:center;color:#5a748a;font-size:12px;margin-top:12px">
    <div class="notes">
      Build <strong>v8.0.0</strong> · Next‑Best‑Action Coach · On‑Device Learning · Ambient Normalization · Smart Replay retained · What‑If hooks in place · CSV aligned · Full confirm list · Report note intact.
    </div>
  </footer>
</div>

<!-- Modals -->
<div id="whyModal">
  <div id="whyCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Why this diagnosis?</strong>
      <button id="whyClose" class="btn secondary" style="padding:6px 10px">Close</button>
    </div>
    <div id="whyContent" style="margin-top:8px;font-size:14px;color:#0a1e2e"></div>
  </div>
</div>

<div id="compareModal">
  <div id="compareCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Compare Snapshots</strong>
      <button id="compareClose" class="btn secondary" style="padding:6px 10px">Close</button>
    </div>
    <div id="compareContent" style="margin-top:8px;font-size:14px;color:#0a1e2e"></div>
  </div>
</div>

<div id="replayModal">
  <div id="replayCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Smart Replay — Animated Trends</strong>
      <button id="replayClose" class="btn secondary" style="padding:6px 10px">Close</button>
    </div>
    <div id="replayControls" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
      <label>Case ID</label>
      <input id="replayCase" type="text" placeholder="enter Case ID or leave blank for latest" style="flex:1;min-width:220px">
      <button class="btn secondary" id="replayLoad">Load</button>
      <button class="btn primary" id="replayPlay">Play</button>
      <button class="btn secondary" id="replayPause">Pause</button>
      <label>Speed</label>
      <select id="replaySpeed">
        <option value="1">1x</option>
        <option value="2">2x</option>
        <option value="4">4x</option>
      </select>
      <input id="replayScrub" type="range" min="0" max="100" value="0" style="flex:1">
    </div>
    <div style="width:100%;height:380px"><canvas id="replayChart"></canvas></div>
    <div id="replayLegend" style="font-size:12px;color:#56728a;margin-top:6px"></div>
  </div>
</div>

<script src="./normalize.js?v=8.0.0"></script>
<script src="./learning.js?v=8.0.0"></script>
<script src="./coach.js?v=8.0.0"></script>
<script src="./whatif.js?v=8.0.0"></script>
<script src="./send-report.v74b.unified.js?v=3"></script>
<script>
// Minimal glue: history storage key for continuity
const HIST_KEY='hvac_hist_v7_4b';
</script>
<script src="./app-core.v8.js?v=8.0.0"></script>
</body>
</html>
